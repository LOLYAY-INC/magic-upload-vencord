/**
 * @name MagicUpload
 * @website https://github.com/mack/magic-upload
 * @source 
 */

module.exports = (() => {
    const config = {"main":"bundled.js","info":{"name":"Magic Upload","authors":[{"name":"Mack","discord_id":"365247132375973889","github_username":"mack","twitter_username":"mackboudreau"}],"version":"0.0.1","description":"🧙‍♀️ A BetterDiscord plugin to automagically upload files over 8MB.","github":"https://github.com/mack/magic-upload","github_raw":""},"changelog":[],"defaultConfig":[]};

    return !global.ZeresPluginLibrary ? class {
        constructor() {this._config = config;}
        getName() {return config.info.name;}
        getAuthor() {return config.info.authors.map(a => a.name).join(", ");}
        getDescription() {return config.info.description;}
        getVersion() {return config.info.version;}
        load() {
            BdApi.showConfirmationModal("Library Missing", `The library plugin needed for ${config.info.name} is missing. Please click Download Now to install it.`, {
                confirmText: "Download Now",
                cancelText: "Cancel",
                onConfirm: () => {
                    require("request").get("https://rauenzi.github.io/BDPluginLibrary/release/0PluginLibrary.plugin.js", async (error, response, body) => {
                        if (error) return require("electron").shell.openExternal("https://betterdiscord.net/ghdl?url=https://raw.githubusercontent.com/rauenzi/BDPluginLibrary/master/release/0PluginLibrary.plugin.js");
                        await new Promise(r => require("fs").writeFile(require("path").join(BdApi.Plugins.folder, "0PluginLibrary.plugin.js"), body, r));
                    });
                }
            });
        }
        start() {}
        stop() {}
    } : (([Plugin, Api]) => {
        const plugin = (H,I)=>{"use strict";let j=require("http"),$=require("https"),F=require("url"),k=require("crypto"),T=require("fs"),{Logger:l,Patcher:u,WebpackModules:U}=I,g=U.getByProps("anyFileTooLarge","maxFileSize"),K=U.getByProps("instantBatchUpload","upload"),q=global.BdApi.findModuleByProps("sendMessage"),J=BdApi.findModuleByProps("BorderColors"),O=BdApi.findModuleByProps("useModalsStore","closeModal"),n={oauth:{handler:{port:29842,host:"localhost"},clientId:"911268808772-r7sa3s88f2o36hdcu9g4tmih6dbo4n77.apps.googleusercontent.com",clientSecret:"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"},storage:{algorithm:"aes-256-ctr",secretKey:"jXn2r5u8x/A?D*G-KaPdSgVkYp3s6v9y",iv:k.randomBytes(16),credentialsKey:"_magicupload_oa_creds_gd",uploadsKey:"_magicupload_files_inprogress"},upload:{chunkMultiplier:10}},m=200,R=308,N=401,V=404,Y=500,Z=`https://accounts.google.com/o/oauth2/v2/auth?scope=https://www.googleapis.com/auth/drive&redirect_uri=http://${n.oauth.handler.host}:${n.oauth.handler.port}&response_type=code&client_id=${n.oauth.clientId}`,D="https://oauth2.googleapis.com/token",W="https://oauth2.googleapis.com/revoke",X="https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable",Q="https://www.googleapis.com/drive/v3/files",ee="reader",te="anyone",oe=()=>'<!DOCTYPE html><html> <head> <meta charset="UTF-8"> <link rel="preconnect" href="https://fonts.googleapis.com"> <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&family=Staatliches&display=swap" rel="stylesheet"> <title>Magic Upload - Google Drive Connected</title> <script src="https://kit.fontawesome.com/9fd6d0c095.js" crossorigin="anonymous"><\/script> </head> <body> <style> * { box-sizing: border-box; } body { max-width: 870px; margin: 0 auto; } .container { text-align: center; font-family: "Roboto", sans-serif; display: flex; justify-content: center; align-items: center; flex-direction: column; height: 90vh; position: relative; color: #363636; padding-left: 5rem; padding-right: 5rem; } .header img { width: 80px; } .header { display: flex; align-items: center; font-family: "Staatliches", cursive; font-size: 48px; margin-bottom: 0; } .header i { font-size: 18px; margin: 0 0.5rem; } p { padding: 0 2rem; margin-top: 0; font-size: 18px; line-height: 24px; } .footer { position: absolute; bottom: 1rem; font-size: 14px; opacity: 0.4; } .magic { color: #5e2de5; text-shadow: 0 8px 24px rgb(94 45 229 / 25%); } .tooltip { position: relative; display: inline-block; border-bottom: 1px dotted black; } .tooltip .tooltiptext { font-size: 16px; line-height: 20px; visibility: hidden; width: 120px; bottom: 130%; left: 50%; margin-left: -60px; background-color: rgba(0,0,0,0.9); color: #fff; text-align: center; padding: 5px 0; border-radius: 6px; opacity: 0; transition: .3s; position: absolute; z-index: 1; } .tooltip .tooltiptext::after { content: " "; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #363636 transparent transparent transparent; } .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; } a { color: #363636; transition: .3s; } a:hover{ color: #5e2de5; text-shadow: 0 8px 24px rgb(94 45 229 / 25%); } hr { width: 50px; opacity: 0.5; } </style> <div class="container"> <h1 class="header"><span class="magic">MagicUpload</span> <i class="fa-solid fa-link"></i> <img src="https://upload.wikimedia.org/wikipedia/commons/1/12/Google_Drive_icon_%282020%29.svg" /></h1> <hr> <p class="about">\u2705 You"ve successfully linked your Google Drive account! You can now upload files that exceed your discord limit and they"ll automatically uploaded to your drive.</p> <p class="help">Need any help? Checkout our <a href="https://github.com/mack/magic-upload" class="tooltip"> <i class="fa-brands fa-github"></i> <span class="tooltiptext">GitHub</span> </a> or <a href="" class="tooltip"> <i class="fa-brands fa-discord"></i> <span class="tooltiptext">Community Discord</span> </a> . </p> <span class="footer">&#169; Mackenzie Boudreau</span> </div> <script src="https://unpkg.com/scrollreveal@4.0.0/dist/scrollreveal.min.js"><\/script> <script src="https://cdn.jsdelivr.net/npm/js-confetti@latest/dist/js-confetti.browser.js"><\/script> <script> const sr = ScrollReveal({ origin: "top", distance: "60px", duration: 2500, delay: 400, }); sr.reveal(".header", {delay: 700}); sr.reveal("hr", {delay: 500}); sr.reveal(".about", {delay: 900, origin: "bottom"}); sr.reveal(".help", {delay: 1000, origin: "bottom"}); sr.reveal(".footer", {delay: 800, origin: "bottom"}); const jsConfetti = new JSConfetti(); setTimeout(() => { jsConfetti.addConfetti() }, 2000); <\/script> </body></html>',se=r=>`<!DOCTYPE html><html> <head> <meta charset="UTF-8"> <link rel="preconnect" href="https://fonts.googleapis.com"> <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@300&family=Roboto:wght@300;400;500&family=Staatliches&display=swap" rel="stylesheet"> <title>Magic Upload - Error</title> <script src="https://kit.fontawesome.com/9fd6d0c095.js" crossorigin="anonymous"><\/script> </head> <body> <style> * { box-sizing: border-box; } body { max-width: 870px; margin: 0 auto; } .container { text-align: center; font-family: "Roboto", sans-serif; display: flex; justify-content: center; align-items: center; flex-direction: column; height: 90vh; position: relative; color: #363636; padding-left: 5rem; padding-right: 5rem; } h1 { font-family: "Staatliches", cursive; font-size: 48px; margin-bottom: 0; } p { padding: 0 2rem; margin-top: 0; font-size: 18px; line-height: 24px; } .footer { position: absolute; bottom: 1rem; font-size: 14px; opacity: 0.4; } .error, .header > i { color: rgb(229, 45, 45); text-shadow: 0 8px 24px rgb(229 45 45 / 25%); } .tooltip { position: relative; display: inline-block; border-bottom: 1px dotted black; } .tooltip .tooltiptext { font-size: 16px; line-height: 20px; visibility: hidden; width: 120px; bottom: 130%; left: 50%; margin-left: -60px; background-color: rgba(0,0,0,0.9); color: #fff; text-align: center; padding: 5px 0; border-radius: 6px; opacity: 0; transition: .3s; position: absolute; z-index: 1; } .tooltip .tooltiptext::after { content: " "; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #363636 transparent transparent transparent; } .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; } a { color: #363636; transition: .3s; } a:hover{ color: #5e2de5; text-shadow: 0 8px 24px rgb(94 45 229 / 25%); } hr { width: 50px; opacity: 0.5; } .error_container { max-width: 100%; position: relative; } .error_container:hover .error_label { opacity: 0.3; } .error_code { font-size: 14px; background-color: rgba(0,0,0,0.92); border-radius: 6px; padding-top: 2rem; padding-bottom: 2rem; padding-right: 2rem; padding-left: 2rem; color: white; text-align: left; word-wrap: break-word; font-family: 'Roboto Mono', monospace; } .error_label { transition: .3s; cursor: default; font-size: 12px; text-transform: uppercase; opacity: 0; color: white; position: absolute; right: 2rem; top: 1rem; } </style> <div class="container"> <h1 class="header"><i class="fa-solid fa-triangle-exclamation"></i> Uh oh, something went <span class="error">wrong</span> <i class="fa-solid fa-triangle-exclamation"></i></h1> <hr> <p class="about">We weren&#39;t able to connect your Google Drive account with MagicUpload. Please try again or reach out to help in our community discord. </p> <p class="help">Need any help? Checkout our <a href="https://github.com/mack/magic-upload" class="tooltip"> <i class="fa-brands fa-github"></i> <span class="tooltiptext">GitHub</span> </a> or <a href="" class="tooltip"> <i class="fa-brands fa-discord"></i> <span class="tooltiptext">Community Discord</span> </a> . </p> <div class="error_container"> <span class="error_label">OAuth Response // JSON</span> <div class="error_code"> ${r.error_message} </div> </div> <span class="footer">&#169; Mackenzie Boudreau</span> </div> <script src="https://unpkg.com/scrollreveal@4.0.0/dist/scrollreveal.min.js"><\/script> <script src="https://cdn.jsdelivr.net/npm/js-confetti@latest/dist/js-confetti.browser.js"><\/script> <script> const sr = ScrollReveal({ origin: "top", distance: "60px", duration: 2500, delay: 400, }); sr.reveal(".header", {delay: 700}); sr.reveal("hr", {delay: 500}); sr.reveal(".about", {delay: 900, origin: "bottom"}); sr.reveal(".help", {delay: 1000, origin: "bottom"}); sr.reveal(".error_code", {delay: 1000, origin: "bottom"}); sr.reveal(".footer", {delay: 800, origin: "bottom"}); <\/script> </body></html>`,S=(r,e)=>{let t=e.getAccessToken();return t&&(r.headers={...r.headers,Authorization:"Bearer "+t}),r},G=(r,e)=>r.length>e?r.substr(0,e-1)+"...":r,ie=r=>`https://drive.google.com/file/d/${r}`,ue=r=>`https://drive.google.com/uc?export=download&id=${r}`,re=(r,e,t)=>({lastModified:r.lastModified,lastModifiedDate:r.lastModifiedDate,name:r.name,path:r.path,size:r.size,type:r.type,webkitRelativePath:r.webkitRelativePath,mu_destination:e,mu_content:t}),M=r=>{let e=r.split("-");if(e.length===2)return parseInt(e[1],10)},P=()=>{let r=O.useModalsStore.getState().default[0];r&&O.closeModal(r.key)},E=(r,e)=>BdApi.showToast(r,{type:"success",...e}),ne=(r,e)=>BdApi.showToast(r,{type:"info",...e}),ge=(r,e)=>BdApi.showToast(r,{type:"warning",...e}),ae=(r,e)=>BdApi.showToast(r,{type:"error",...e});class le{constructor(e,t){this.storage=e,this.oauther=t,this.continue()}continue(){let e=this.getRegisteredUploads();for(let t in e)e.hasOwnProperty(t)&&this.getStreamStatus(t,o=>{switch(o.status){case m:this.unregisterUpload(t);break;case R:l.log("Resuming inprogress upload.");let s=M(o.headers.get("Range"));this.streamChunks(t,e[t],s,i=>{this.unregisterUpload(t)});break;case V:this.unregisterUpload(t),this.upload(file);break;default:}})}getRegisteredUploads(){return this.storage.load(n.storage.uploadsKey)||{}}registerUpload(e,t){l.log("Registering new file into upload registry.");let o=JSON.parse(JSON.stringify(t)),s=this.getRegisteredUploads();s[e]=o,this.storage.store(n.storage.uploadsKey,s)}unregisterUpload(e){l.log("Unregistering upload from upload registry.");let t=this.getRegisteredUploads();delete t[e],this.storage.store(n.storage.uploadsKey,t)}getStreamStatus(e,t){let o=S({method:"PUT",headers:{"Content-Length":0,"Content-Range":"bytes 0-*/*"}},this.storage);fetch(e,o).then(s=>{t&&t(s)})}streamChunks(e,t,o,s){let i=this.storage.getAccessToken(),a=n.upload.chunkMultiplier*256*1024;console.log(e),console.log(t);let c=Buffer.alloc(a);T.open(t.path,"r",function(d,f){(d||!f)&&s(null,d);let v=p=>{T.read(f,c,0,a,p,(x,w)=>{x&&s(null,x);var h;w<a?h=c.slice(0,w):h=c;let y=p,pe=p+(h.length-1),C=t.size,A=new URL(e),he={host:A.host,path:A.pathname+A.search,method:"PUT",headers:{Authorization:"Bearer "+i,"Content-Length":h.length,"Content-Range":`bytes ${y}-${pe}/${C}`}};l.info(`[${(y/C*100).toFixed(2)}%] Uploading ${t.name} (${y}/${C})`);let L=$.request(he,function(b){if(b.statusCode===R&&(p=M(b.headers.range),v(p)),b.statusCode===m){var B="";b.on("data",z=>{B+=z}),b.on("close",()=>{T.close(f,z=>{E(`Successfully uploaded ${G(t.name,35)}`),s(JSON.parse(B),null)})})}});L.write(h),L.end()})};v(o)})}share(e,t,o){let s={role:ee,type:te},i=S({method:"POST",headers:{"Content-Type":"application/json; charset=UTF-8"},body:JSON.stringify(s)},this.storage);fetch(Q+`/${e}/permissions`,i).then(a=>a.json()).then(a=>{a.error?a.error.code===N&&!o&&this.oauther.refresh(()=>{this.share(e,t,!0)}):t&&t()})}upload(e,t){let o={name:e.name,mimeType:e.type},s=S({method:"POST",headers:{"Content-Type":"application/json; charset=UTF-8","Content-Length":e.size},body:JSON.stringify(o)},this.storage);fetch(X,s).then(i=>{if(i.status===m){let a=i.headers.get("Location");this.registerUpload(a,e),this.streamChunks(a,e,0,(c,d)=>{this.unregisterUpload(a),d===null?this.share(c.id,()=>{this.sendUploadMessage(e,ie(c.id))}):(l.err("Upload has failed."),errToast(`Upload failed ${G(e.name,35)}`))})}else i.status===N&&!t&&this.oauther.refresh(()=>{this.upload(e,!0)})})}sendUploadMessage(e,t){console.log(e);let o=e.mu_content!==""?e.mu_content+`
`+t:t;q.sendMessage(e.mu_destination,{content:o,validNonShortcutEmojis:[]})}}class ce{constructor(e){this.pluginName=e;let{credentialsKey:t}=n.storage;this.deleteCredentials=()=>this.delete(t),this.getAccessToken=()=>{let o=this.load(t,!0);return o&&o.access_token},this.patchAccessToken=o=>{let s=this.load(t,!0);return s.access_token=o,this.store(t,s,!0),o}}encrypt(e){let{algorithm:t,secretKey:o,iv:s}=n.storage,i=k.createCipheriv(t,o,s),a=Buffer.concat([i.update(e),i.final()]);return{iv:s.toString("hex"),content:a.toString("hex")}}decrypt(e){let{algorithm:t,secretKey:o}=n.storage,s=k.createDecipheriv(t,o,Buffer.from(e.iv,"hex"));return Buffer.concat([s.update(Buffer.from(e.content,"hex")),s.final()]).toString()}load(e,t){var o=BdApi.loadData(this.pluginName,e);if(o&&t){let s=Buffer.from(o,"base64").toString("ascii");o=JSON.parse(this.decrypt(JSON.parse(s)))}return o}store(e,t,o){var s;if(o){let i=this.encrypt(JSON.stringify(t));s=Buffer.from(JSON.stringify(i)).toString("base64")}else s=t;BdApi.saveData(this.pluginName,e,s)}delete(e){BdApi.deleteData(this.pluginName,e)}}class de{constructor(e){this.storage=e,this.server=j.createServer((t,o)=>{let{query:s}=F.parse(t.url,!0);console.log("can handle a request"),s.code&&(l.log("Recieved authorization code."),this.requestAccessToken(s.code,i=>{let{access_token:a,refresh_token:c}=i;a&&c?(l.log("Exchanged authorization code for access and refresh tokens."),this.storage.store(n.storage.credentialsKey,i,!0),o.writeHeader(m,{"Content-Type":"text/html"}),o.write(oe()),E("Google Drive connected!",{timeout:5500})):(l.err("Failed to retrieve access and refresh tokens."),o.writeHeader(Y,{"Content-Type":"text/html"}),o.write(se({error_message:JSON.stringify(i)})),ae("An error occured connecting Google Drive",{timeout:5500})),o.end(),this.shutdownHandler()}))})}launch(){this.activateHandler(()=>{l.log("Sending user to OAuth consent flow."),window.open(Z)})}activateHandler(e){if(this.server.listening){e();return}let{port:t,host:o}=n.oauth.handler;this.server.listen(t,o,()=>{l.log(`Listening for OAuth redirects on http://${o}:${t}...`),e&&e()})}shutdownHandler(e){this.server.close(e)}requestAccessToken(e,t){let o=new URLSearchParams({client_id:n.oauth.clientId,client_secret:n.oauth.clientSecret,code:e,grant_type:"authorization_code",redirect_uri:`http://${n.oauth.handler.host}:${n.oauth.handler.port}`}).toString();fetch(D,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:o}).then(i=>i.json()).then(i=>{t&&t(i)})}refresh(e){let{refresh_token:t}=this.storage.load(n.storage.credentialsKey,!0);t?this.refreshAccessToken(t,({access_token:o})=>{o?(l.log("Successfully refreshed access token."),this.storage.patchAccessToken(o),e&&e(o)):(l.warn("Refresh token may have expired. Please reconnect your Google account."),this.storage.deleteCredentials(),this.launch())}):(l.err("Something went wrong. Clearing OAuth credentials."),this.storage.deleteCredentials())}refreshAccessToken(e,t){let o=new URLSearchParams({client_id:n.oauth.clientId,client_secret:n.oauth.clientSecret,refresh_token:e,grant_type:"refresh_token"}).toString();fetch(D,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:o}).then(i=>i.json()).then(i=>{t&&t(i)})}revokeToken(e){let t={method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"}};fetch(W+`?token=${e}`,t).then(o=>{o.status===m?l.log("Token has successfully been revoked."):l.warn("Unable to revoke OAuth token.")})}}return class extends H{openOAuthPrompt(){BdApi.showConfirmationModal("\u{1F50C} Connect your Google Drive","Magic Upload requires Google Drive. To use this plugin you must connect your Google account.",{confirmText:"Connect Google Account",cancelText:"Disable Plugin",onConfirm:()=>{this.oauther.launch()},onCancel:()=>{BdApi.Plugins.disable(this.getName())}})}patchModules(){l.log("Patching Discord file modules."),u.instead(g,"maxFileSize",(e,t,o)=>{let[s,i]=t;return i===!0?o(s):Number.MAX_VALUE}),u.instead(g,"anyFileTooLarge",()=>!1),u.instead(g,"uploadSumTooLarge",()=>!1),u.instead(g,"getUploadFileSizeSum",()=>0),u.instead(K,"uploadFiles",(e,[t],o)=>{let{channelId:s,uploads:i,parsedMessage:a}=t;i.forEach(c=>{if(c.item.file.size<this.uploadLimit()){let d=Object.assign({},t);d.uploads=[c],o(d)}else{let d=re(c.item.file,s,a.content);this.uploader.upload(d)}})})}init(){this.storage=new ce(this.getName()),this.oauther=new de(this.storage),this.uploader=new le(this.storage,this.oauther),this.uploadLimit=()=>g.maxFileSize(_,!0)}onStart(){this.init(),this.storage.getAccessToken()?this.patchModules():this.openOAuthPrompt()}onStop(){l.log("MagicUpload has stopped..."),this.oauther.shutdownHandler(),u.unpatchAll()}buildSetting(e){class t extends ZLibrary.Settings.SettingField{constructor(f,v,p,x){let w={display:"flex"},h=BdApi.React.createElement(J,{onClick:x},p);super(f,v,_,y=>BdApi.React.createElement("div",{...y,style:w},h),{})}}let{name:o,note:s,type:i,value:a,onClick:c}=e;return i==="button"?new t(o,s,a,c):super.buildSetting(e)}getSettingsPanel(){let e=this.buildSettingsPanel(),t=this.storage.load(n.storage.credentialsKey,!0);var o;t?o={controls:[{type:"switch",id:"automatic_file_upload",name:"Automatic file uploading",note:"Do not prompt me when uploading files that exceed the upload limit.",value:!0,onChange:i=>console.log("CHANGINGINSDGINGING")},{type:"switch",id:"rich_embed",name:"Google Drive embeds",note:"Attempt to display an embedded preview of content from google drive links.",value:!0,onChange:i=>console.log("CHANGINGINSDGINGING")},{type:"switch",id:"verbose",name:"Verbose Logs",note:"Display verbose console logs. Useful for debugging.",value:!1,onChange:i=>console.log("CHANGINGINSDGINGING")},{type:"textbox",id:"access_token",name:"Google Drive access token",note:"This value is immutable.",value:t?t.access_token:""},{type:"textbox",id:"refresh_token",name:"Google Drive refresh token",note:"This value is immutable.",value:t?t.refresh_token:""},{type:"button",value:"Unlink Google Drive",onClick:()=>{this.oauther.revokeToken(t.refresh_token),this.storage.deleteCredentials(),ne("Google Drive has been unlinked.",{timeout:5500}),P()}}]}:o={description:`\u{1F50C} Hello! It looks like you haven't given access to your Google Drive. 
                        This plugin <i>requires</i> you to sign in with Google in order to function.`,controls:[{type:"button",value:"Connect Google Account",onClick:()=>{this.oauther.launch(),P()}}]},o.controls.forEach(i=>e.append(this.buildSetting(i)));let s=e.getElement();if(o.description){let i=document.createElement("p");i.style=`
                    color: rgb(185, 187, 190);
                    font-size: 16px;
                    line-height: 18px;
                    margin-top: 0;
                    margin-bottom: 0.85rem;
                `,i.innerHTML=o.description,s.prepend(i)}return s}}};
        return plugin(Plugin, Api);
    })(global.ZeresPluginLibrary.buildPlugin(config));
})();